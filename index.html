<!DOCTYPE html>
<html>
<head>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      text-align: center; 
      margin: 0; 
      padding: 50px; 
      transition: background-color 0.5s; 
    }
    #slider { 
      width: 200px; 
      margin: 20px auto; 
    }
    #status { font-size: 24px; }
    #timer { font-size: 18px; color: red; margin-top: 10px; }
    #dogImage { max-width: 300px; margin-top: 20px; }
    #contactSection { position: absolute; top: 10px; right: 10px; }
    #changeContactBtn { padding: 5px 10px; font-size: 14px; }
  </style>
</head>
<body id="body">
  <h2>Home Alone Mini App</h2>
  <input type="range" id="slider" min="0" max="1" value="0" step="1" oninput="updateStatus()">
  <div id="status">Переместите слайдер</div>
  <div id="timer" style="display: none;">Осталось: 30 сек.</div>
  <img id="dogImage" src="https://via.placeholder.com/300?text=Neutral+Dog" alt="Dog">
  <div id="contactSection" style="display: none;">
    <span id="emergencyContact"></span>
    <button id="changeContactBtn" onclick="showContactInput()">Изменить контакт</button>
  </div>
  <div id="contactInputContainer">
    <input id="contactInput" placeholder="@username" onblur="saveContact()">
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    let contactSaved = false;
    let timerInterval = null;

    function updateStatus() {
      const slider = document.getElementById('slider');
      const body = document.getElementById('body');
      const status = document.getElementById('status');
      const dogImage = document.getElementById('dogImage');
      const timer = document.getElementById('timer');
      const contactSection = document.getElementById('contactSection');
      const contactInputContainer = document.getElementById('contactInputContainer');

      if (slider.value == 0) {
        body.style.backgroundColor = 'rgba(255, 100, 100, 0.3)'; // Бледно-красный
        status.textContent = 'Не дома';
        dogImage.src = 'https://i.postimg.cc/pLjFJ5TD/2025-08-19-16-33-44.png'; // Грустная собака
        sendStatus('не дома');
        startTimer();
      } else {
        body.style.backgroundColor = 'rgba(100, 255, 100, 0.3)'; // Светло-зелёный
        status.textContent = 'Дома';
        dogImage.src = 'https://i.postimg.cc/g2c0nwhz/2025-08-19-16-37-23.png'; // Счастливая собака
        sendStatus('дома');
        stopTimer();
      }
    }

    function startTimer() {
      let timeLeft = 30;
      document.getElementById('timer').style.display = 'block';
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = `Осталось: ${timeLeft} сек.`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          document.getElementById('timer').style.display = 'none';
        }
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        document.getElementById('timer').style.display = 'none';
      }
    }

    function sendStatus(status) {
      if (!tg.initDataUnsafe.user || !tg.initDataUnsafe.user.id) {
        tg.showAlert('Ошибка: Не удалось получить ID пользователя.');
        return;
      }
      fetch('https://homealoneminiapp.onrender.com/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id, status: status })
      }).then(response => {
        if (!response.ok) tg.showAlert('Ошибка сети или сервера.');
      }).catch(() => tg.showAlert('Ошибка сети.'));
    }

    function saveContact() {
      const contact = document.getElementById('contactInput').value;
      if (!contact.startsWith('@')) {
        tg.showAlert('Контакт должен начинаться с @!');
        return;
      }
      fetch('https://homealoneminiapp.onrender.com/contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id, contact: contact })
      }).then(response => {
        if (response.ok) {
          tg.showAlert('Контакт сохранён!');
          document.getElementById('contactInputContainer').style.display = 'none';
          document.getElementById('emergencyContact').textContent = `Экстренный контакт: ${contact}`;
          document.getElementById('contactSection').style.display = 'block';
          contactSaved = true;
        } else tg.showAlert('Ошибка сохранения контакта.');
      }).catch(() => tg.showAlert('Ошибка сети.'));
    }

    function showContactInput() {
      document.getElementById('contactInputContainer').style.display = 'block';
      document.getElementById('contactSection').style.display = 'none';
      contactSaved = false;
    }

    // Проверка сохранённого контакта при загрузке
    if (tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
      fetch(`https://homealoneminiapp.onrender.com/contact?user_id=${tg.initDataUnsafe.user.id}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      }).then(response => response.json())
        .then(data => {
          if (data.emergency_contact) {
            document.getElementById('contactInputContainer').style.display = 'none';
            document.getElementById('emergencyContact').textContent = `Экстренный контакт: ${data.emergency_contact}`;
            document.getElementById('contactSection').style.display = 'block';
            contactSaved = true;
          }
        }).catch(() => {});
    }
  </script>
</body>
</html>
